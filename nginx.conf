# File: ./nginx/nginx.conf ĐÃ SỬA LỖI

server {
    listen 80;
    server_name localhost;

    # 1. CẤU HÌNH REVERSE PROXY cho API ĐĂNG NHẬP (Giữ nguyên)
    # Node-RED phải lắng nghe POST /api/login
    location /api/login {
        proxy_pass http://nodered:1880/api/login; 
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 2. CẤU HÌNH PHỤC VỤ TỆP TĨNH (Sửa lỗi 404 cho SPA)
    # Nếu không tìm thấy file tĩnh, hãy trả về index.html (Cần thiết cho SPA)
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html; 
        # Đã thay =404 bằng /index.html để SPA hoạt động
    }
    
    # 3. CẤU HÌNH CHO NODE-RED EDITOR
    location /nodered/ {
        proxy_pass http://nodered:1880/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 4. CẤU HÌNH CHO GRAFANA
    location /grafana/ {
        proxy_pass http://grafana:3000/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 5. CẤU HÌNH CHO PHPMYADMIN
    location /phpmyadmin/ {
        proxy_pass http://phpmyadmin:80/; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ADMIN:
    location /admin/ {
        # Loại bỏ /admin/ khỏi đường dẫn trước khi gửi đến Node-RED
        rewrite ^/admin/(.*)$ /$1 break; 
        
        proxy_pass http://nodered:1880; 
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Thành phần đơn hàng
    location /admin/orders {
        # 'nodered:1880' là địa chỉ Node-RED
        # Chúng ta chuyển hướng đến đường dẫn tương ứng trong Node-RED.
        proxy_pass http://nodered:1880/admin/orders; 
        
        # Thiết lập các header chuẩn
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /order {
        # 'nodered:1880' là tên dịch vụ Node-RED
        proxy_pass http://nodered:1880/order; 
        
        # Thiết lập các header chuẩn
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bắt yêu cầu GET /products
    location /products {
        # 'nodered:1880' là tên dịch vụ Node-RED
        proxy_pass http://nodered:1880/products; 
        
        # Thiết lập các header chuẩn
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Bắt yêu cầu GET /categories
    location /categories {
    # Chuyển tiếp yêu cầu đến Node-RED (thường là cổng 1880)
        proxy_pass http://nodered:1880/categories;
        
        # Đảm bảo các headers được chuyển tiếp đúng cách
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
}

}